---
- name: Check whether target VMIDs already exist in Proxmox
  community.proxmox.proxmox_vm_info:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id | default(omit) }}"
    api_token_secret: "{{ pve_api_token_secret | default(omit) }}"
    api_password: "{{ pve_api_password | default(omit) }}"
    validate_certs: "{{ pve_validate_certs | default(false) }}"
    type: qemu
    vmid: "{{ item.vmid }}"
  loop: "{{ pve_clone_plan }}"
  register: vmid_info

- name: Fail if any target VMID already exists
  ansible.builtin.assert:
    that:
      - (item.proxmox_vms | default([]) | length) == 0
    fail_msg: >-
      VMID {{ item.item.vmid }} for {{ item.item.host }} already exists in Proxmox.
      Choose a different pve_vmid or adjust pve_clone_vmid_start.
  loop: "{{ vmid_info.results }}"

- name: Clone from template to each target VM
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id | default(omit) }}"
    api_token_secret: "{{ pve_api_token_secret | default(omit) }}"
    api_password: "{{ pve_api_password | default(omit) }}"
    validate_certs: "{{ pve_validate_certs | default(false) }}"
    # Node where the template resides (and default target node)
    node: "{{ hostvars[item.host].pve_clone_target_node | default(pve_clone_target_node) }}"
    # Source template (VMID)
    clone: "{{ pve_clone_template_id | int }}"
    # New VM identity
    newid: "{{ item.vmid }}"
    name: "{{ item.host }}"
    # Clone options
    full: "{{ pve_clone_full | default(true) }}"
    storage: "{{ hostvars[item.host].pve_clone_storage | default(pve_clone_storage) | default(omit) }}"
    format: "{{ hostvars[item.host].pve_clone_format | default(pve_clone_format) | default(omit) }}"
    pool: "{{ (hostvars[item.host].pve_clone_pool | default(pve_clone_pool)) if ((hostvars[item.host].pve_clone_pool | default(pve_clone_pool) | default('')) | length > 0) else omit }}"
    timeout: "{{ pve_clone_timeout | default(900) }}"
  loop: "{{ pve_clone_plan }}"

- name: Apply hostname + static IP via cloud-init (from inventory vars)
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id | default(omit) }}"
    api_token_secret: "{{ pve_api_token_secret | default(omit) }}"
    api_password: "{{ pve_api_password | default(omit) }}"
    validate_certs: "{{ pve_validate_certs | default(false) }}"
    node: "{{ hostvars[item.host].pve_clone_target_node | default(pve_clone_target_node) }}"
    vmid: "{{ item.vmid }}"
    name: "{{ item.host }}"
    ciuser: "{{ hostvars[item.host].pve_ciuser | default(pve_ciuser) | default(omit) }}"
    sshkeys: "{{ hostvars[item.host].pve_sshkeys | default(pve_sshkeys) | default(omit) }}"
    nameservers: "{{ hostvars[item.host].pve_nameservers | default(pve_nameservers) | default(omit) }}"
    searchdomains: "{{ hostvars[item.host].pve_searchdomains | default(pve_searchdomains) | default(omit) }}"
    ipconfig:
      ipconfig0: "ip={{ hostvars[item.host].ansible_host }}/{{ hostvars[item.host].pve_prefix }},gw={{ hostvars[item.host].pve_gateway }}"
    update: true
  loop: "{{ pve_clone_plan }}"

- name: Start cloned VMs
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id | default(omit) }}"
    api_token_secret: "{{ pve_api_token_secret | default(omit) }}"
    api_password: "{{ pve_api_password | default(omit) }}"
    validate_certs: "{{ pve_validate_certs | default(false) }}"
    node: "{{ hostvars[item.host].pve_clone_target_node | default(pve_clone_target_node) }}"
    vmid: "{{ item.vmid }}"
    state: started
  loop: "{{ pve_clone_plan }}"