---
- name: Assert required Proxmox API variables are defined
  ansible.builtin.assert:
    that:
      - pve_api_host is defined
      - pve_api_user is defined
      - pve_api_token_full_id is defined
      - pve_api_token_secret is defined
    fail_msg: >
      Missing required Proxmox vars.
      Need: pve_api_host, pve_api_user, pve_api_token_full_id, pve_api_token_secret.

- name: Ping Proxmox API host from control node
  ansible.builtin.command: "ping -c3 -W5 {{ pve_api_host }}"
  register: pve_icmp_ping
  changed_when: false
  failed_when: pve_icmp_ping.rc != 0

- name: Query Proxmox API /version endpoint with token
  ansible.builtin.uri:
    url: "https://{{ pve_api_host }}:{{ pve_api_port | default(8006) }}/api2/json/version"
    method: GET
    validate_certs: "{{ pve_validate_certs | default(false) }}"
    return_content: true
    status_code: [200]
    headers:
      Authorization: "PVEAPIToken={{ pve_api_token_full_id }}={{ pve_api_token_secret }}"
  register: pve_api_ping
  changed_when: false
  no_log: true

- name: Verify Proxmox API response contains version data
  ansible.builtin.assert:
    that:
      - pve_api_ping.json is defined
      - pve_api_ping.json.data is defined
      - pve_api_ping.json.data.version is defined
    fail_msg: "Reached Proxmox API but did not get expected version data; check token permissions."

- name: Show returned Proxmox version
  ansible.builtin.debug:
    msg: >
      Proxmox connectivity OK: host={{ pve_api_host }},
      version={{ pve_api_ping.json.data.version }},
      release={{ pve_api_ping.json.data.release }}
