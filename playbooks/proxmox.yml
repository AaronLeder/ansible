---
# ===== Connectivity ===== #
- name: Proxmox Host Connectivity
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    pve_api_host: "walnut"
    pve_api_port: 8006
    pve_api_user: "ansible@pve"
    pve_api_token_id: "ansible-maint001"
    pve_api_token_full_id: "{{ pve_api_user }}!{{ pve_api_token_id }}"
    pve_validate_certs: false

  vars_files:
    - ../vault/aaron-homelab.yml
  roles:
    - proxmox-host
  tags:
    - pve_connectivity

# ===== VM State ===== #
- name: Proxmox Change VM State
  hosts: proxmox
  connection: local
  gather_facts: false

  vars:
    pve_api_host: "walnut"
    pve_api_port: 8006
    pve_api_user: "ansible@pve"
    pve_api_token_id: "ansible-maint001"
    pve_api_token_full_id: "{{ pve_api_user }}!{{ pve_api_token_id }}"
    pve_validate_certs: false
    pve_timeout: 300

    # Define the state. Leave undefined or null to skip VM state tasks
    pve_vm_state: 

    # Map of VMIDs per Proxmox node (key must match inventory_hostname_short)
    pve_vm_map:
      walnut: [151, 152]
      rainbow: []
      cheddar: []
      squeak: []

  vars_files:
    - ../vault/aaron-homelab.yml
  roles:
    - proxmox
  tags:
    - pve_state_vm

# ===== VM Clone ===== #
#- name: Clone Proxmox VMs for hosts in pve_vm_to_clone
#  hosts: localhost
#  connection: local
#  gather_facts: false
#
#  vars:
#    pve_api_host: "walnut"
#    pve_api_port: 8006
#    pve_api_user: "ansible@pve"
#    pve_api_token_id: "ansible-maint001"
#    pve_api_token_full_id: "{{ pve_api_user }}!{{ pve_api_token_id }}"
#    pve_validate_certs: false
#
#    # Enable/disable clone workflow cleanly
#    pve_clone_enabled: true
#
#    # Clone params
#    pve_clone_template_id: 100
#    pve_clone_storage: mydata
#    pve_clone_format: qcow2
#    pve_clone_pool: ""
#    pve_clone_vmid_start: 100
#    pve_clone_full: true
#    pve_clone_timeout: 900
#
#  vars_files:
#    - ../vault/aaron-homelab.yml
#  roles:
#    - proxmox
#  tags:
#    - pve_clone_vm

# ===== VM Create ===== #
- name: Create new Proxmox VMs from scratch
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    pve_api_host: "walnut"
    pve_api_port: 8006
    pve_api_user: "ansible@pve"
    pve_api_token_id: "ansible-maint001"
    pve_api_token_full_id: "{{ pve_api_user }}!{{ pve_api_token_id }}"
    pve_validate_certs: false

    # Enable create workflow
    pve_create_enabled: true

    # List the VMs to create (pulls config from inventory)
    pve_create_vm:
      - elastic001.aaron.lan
      #- elastic002.aaron.lan
      #- elastic003.aaron.lan

    # Hardware configuration
    pve_create_cores: 4
    pve_create_sockets: 1
    pve_create_memory: 12288
    pve_create_cpu: "host"

    # BIOS/Machine
    pve_create_bios: "seabios"
    pve_create_machine: "q35"
    pve_create_boot: "order=scsi0;ide2;net0"
    pve_create_ostype: "l26"

    # Storage
    pve_create_storage: "mydata"
    pve_create_disk_size: "100G"
    pve_create_scsihw: "virtio-scsi-single"

    # Network - Using vmbr1 with VLAN 29
    pve_create_bridge: "vmbr1"
    pve_create_vlan: "29"

    # ISO - Use existing ISO from Proxmox storage
    pve_create_iso: "local:iso/ubuntu-24.04.3-live-server-amd64.iso"

    # Additional options
    pve_create_agent: "enabled=1"
    pve_create_onboot: false
    pve_create_protection: false
    pve_create_tags: "elasticsearch,production"
    pve_create_pool: ""

    # Cloud-init configuration (optional)
    pve_create_use_cloudinit: false

    # Auto-start after creation
    pve_create_autostart: false

    pve_create_timeout: 300

  vars_files:
    - ../vault/aaron-homelab.yml
  roles:
    - proxmox-vm
  tags:
    - pve_create_vm